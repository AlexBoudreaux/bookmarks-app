# Ralph Progress Log

Started: 2026-01-22

## Codebase Patterns

(Add reusable patterns here as you discover them)

- Supabase client: Use `@/lib/supabase` for all database queries
- Components: Use shadcn/ui from `@/components/ui/`
- Styling: Tailwind + `cn()` from `@/lib/utils`
- Path alias: `@/*` maps to `./src/*`
- Testing: Vitest for unit tests (`src/**/*.test.ts`), Playwright for E2E (`e2e/**/*.spec.ts`)
- Test imports: Use `@/` path alias in tests (configured in vitest.config.ts)
- Chrome bookmarks: Parse using `parseBookmarksHtml()` from `@/lib/parse-bookmarks`
- Boundary detection: Use `detectBoundary()` from `@/lib/detect-boundary` to split keepers vs to-categorize
- Tweet detection: Use regex `/(?:twitter\.com|x\.com)\/\w+\/status\/\d+/`
- happy-dom quirk: Nested DL tags are children of DT elements, not siblings
- API routes: Create in `src/app/api/` with route.ts files exporting named HTTP method functions
- Domain extraction: Use `extractDomain()` from `@/lib/extract-domain` to normalize URLs
- Date handling in API routes: Accept both Date objects and ISO strings (JSON serialization converts Dates to strings)
- State machines: Use string literal union types for states, useState for current state, conditional rendering based on state
- Category hierarchy: Filter by `parent_id === null` for main categories, `parent_id === mainId` for subcategories
- Tweet embeds: Use `getTweetId()` from `@/lib/tweet-utils` to extract tweet ID, render with `<Tweet id={tweetId} />` from react-tweet
- react-tweet components: Tweet (embed), TweetNotFound (error), TweetSkeleton (loading) - no API key needed

## Key Files

- `src/lib/supabase.ts` - Supabase client
- `supabase/migrations/` - Database migrations
- `PRD.md` - Full product requirements
- `CLAUDE.md` - Coding conventions

---

## 2026-01-22 - SETUP-001
- Verified Vitest infrastructure was already configured
- Created sample test in `src/lib/utils.test.ts`
- Test validates `cn()` function merges classes correctly using clsx + tailwind-merge
- All 6 test cases pass: basic merge, conditionals, conflicting classes, empty inputs, null/undefined, arrays/objects
- Build passes with no type errors

**Files changed:**
- `src/lib/utils.test.ts` (created)
- `package.json` (added happy-dom and @vitest/ui)

**Learnings:**
- Vitest config was already set up with jsdom environment, path aliases (@/), and test setup file
- The cn() utility combines clsx (conditional classes) with tailwind-merge (resolves conflicting Tailwind classes)
- Test naming pattern: `src/**/*.test.ts` for unit tests, `e2e/**/*.spec.ts` for E2E tests

---

## 2026-01-22 - SETUP-002
- Generated TypeScript types from Supabase remote database
- Used `supabase gen types typescript --linked` to generate from linked project
- Created `src/types/database.ts` with complete type definitions
- Includes all four tables: bookmarks, categories, settings, bookmark_categories
- Build passes with no type errors

**Files changed:**
- `src/types/database.ts` (created)

**Learnings:**
- Supabase CLI can generate types from remote project using `--linked` flag
- No need for local Docker instance to generate types
- Generated types include Row, Insert, Update types for each table plus utility types
- Types include the `embedding` vector column for future semantic search

---

## 2026-01-22 - SETUP-003
- Created migration `002_seed_starter_categories.sql` to populate starter categories
- Seeded 9 main categories with 42 subcategories (51 total)
- Categories match PRD specification exactly
- Migration successfully applied via `supabase db push`
- Verified all categories in remote database

**Files changed:**
- `supabase/migrations/002_seed_starter_categories.sql` (created)
- `scripts/verify-categories.ts` (created for verification)

**Learnings:**
- Migration pattern: Insert main categories first, then use SELECT subquery to get parent_id for subcategories
- Each INSERT for subcategories uses `SELECT id FROM categories WHERE name = 'ParentName' AND parent_id IS NULL` to find parent
- Verification script uses manual .env.local parsing since dotenv is not installed
- All 51 categories successfully inserted with correct hierarchy (9 main + 42 sub)

---

## 2026-01-22 - IMP-001
- Implemented Chrome HTML bookmark parser in `src/lib/parse-bookmarks.ts`
- Created comprehensive test suite with 12 test cases in `src/lib/parse-bookmarks.test.ts`
- Parser extracts URL, title, addDate, folderPath, and isTweet from Netscape bookmark format
- Handles nested folder structures correctly
- Detects tweet URLs from both twitter.com and x.com domains
- Supports both DOMParser (browser/happy-dom) and manual regex parsing (Node.js)
- All tests pass, build passes with no type errors

**Files changed:**
- `src/lib/parse-bookmarks.ts` (created)
- `src/lib/parse-bookmarks.test.ts` (created)

**Learnings:**
- happy-dom DOM structure differs from browser: nested DL tags appear as CHILDREN of DT elements, not siblings
- Chrome bookmark format uses Unix timestamps in seconds (not milliseconds) for ADD_DATE attribute
- The `<p>` tags in bookmark HTML are parsed as separate elements by happy-dom
- Tweet detection regex: `/(?:twitter\.com|x\.com)\/\w+\/status\/\d+/`
- Folder paths built by maintaining a stack that grows/shrinks as we enter/exit DL elements

---

## 2026-01-22 - IMP-002
- Implemented boundary detection logic in `src/lib/detect-boundary.ts`
- Created comprehensive test suite with 8 test cases in `src/lib/detect-boundary.test.ts`
- Function finds last occurrence of byebyepaywall.com URL in Tools folder
- Returns keeper count (bookmarks before boundary) and toCategorizeCount (bookmarks after)
- Case-insensitive folder matching for "Tools"
- Handles nested folder paths correctly (e.g., "Bookmarks Bar/Work/Tools")
- All tests pass, build passes with no type errors

**Files changed:**
- `src/lib/detect-boundary.ts` (created)
- `src/lib/detect-boundary.test.ts` (created)

**Learnings:**
- Boundary detection searches backward (from end) to find LAST occurrence of target URL in Tools folder
- Folder name matching requires exact folder part match, not substring (prevents false matches)
- BoundaryResult interface provides clean API: boundaryFound boolean + counts
- When boundary not found, all bookmarks default to toCategorizeCount with keeperCount=0

---

## 2026-01-22 - IMP-003
- Implemented import page dropzone UI with TDD approach
- Created client component `Dropzone` in `src/components/import/dropzone.tsx`
- Updated home page (`src/app/page.tsx`) with fixed header and centered layout
- Added drag-and-drop file upload with visual feedback (hover glow, scale animations)
- Included Chrome export instructions with numbered steps
- Created comprehensive tests in `src/app/page.test.tsx` (4 tests, all passing)
- Screenshot verified UI matches design aesthetic: sleek minimal dashboard, dark theme, polished
- Build passes with no type errors, all 30 tests passing

**Files changed:**
- `src/components/import/dropzone.tsx` (created)
- `src/app/page.tsx` (updated)
- `src/app/page.test.tsx` (created)
- `package.json` (added @testing-library/react, @testing-library/user-event, @testing-library/jest-dom)

**Learnings:**
- TDD workflow effective: write failing tests first, implement until passing
- Testing React Server Components requires rendering the awaited component: `render(await Home())`
- Use `getAllByText` for elements that intentionally appear multiple times on the page
- Mock Supabase responses with `vi.fn()` to control test scenarios (0 bookmarks vs 10+ bookmarks)
- Screenshot verification with dev-browser confirms visual design matches intent
- Dark theme uses CSS variables from globals.css, maintaining consistency across components
- Client components (`'use client'`) needed for interactive elements (drag/drop, state)
- Lucide-react icons (Upload, ArrowRight) for clean, consistent iconography

**Aesthetic decisions:**
- Refined minimal dashboard aesthetic (not bold/flashy)
- Subtle animations: glow on hover, scale transform, smooth transitions
- Radial gradient glow effect on dropzone hover/drag states
- Numbered instruction steps with circular badges using primary color
- Fixed header with backdrop blur for polished feel
- Dark theme only (as specified in PRD)

---

## 2026-01-23 - IMP-004
- Implemented import summary modal component with TDD approach
- Created ImportSummary component using shadcn Dialog and Button
- Modal displays keeper count, to-categorize count, and tweet count with number formatting
- Shows green success alert when boundary found, yellow warning when not found
- Integrated modal into Dropzone component with file parsing logic
- Added loading state with pulse animation during parsing
- "Start Categorizing" button navigates to /categorize page
- All 35 tests passing, build passes with no errors

**Files changed:**
- `src/components/import/import-summary.tsx` (created)
- `src/components/import/import-summary.test.tsx` (created)
- `src/components/import/dropzone.tsx` (updated - added file parsing and modal integration)
- `src/components/ui/dialog.tsx` (added via shadcn)
- `src/components/ui/button.tsx` (added via shadcn)
- `src/app/page.test.tsx` (updated - added useRouter mock)

**Learnings:**
- When testing React components with text split across elements, query individual text parts instead of regex patterns
- useRouter from next/navigation requires mocking in tests with push/refresh methods
- TDD workflow: write failing tests, implement component, run tests until passing
- shadcn Dialog component provides accessible modal with backdrop, close button, and animations
- Number formatting with toLocaleString('en-US') adds thousand separators for readability
- Loading states should disable interactive elements (pointer-events-none on label)
- Fragment (<>) wrapping needed when returning multiple root elements

**Design decisions:**
- Sleek card-based layout with hover effects and gradient backgrounds
- Color-coded status indicators (green for success, yellow for warning)
- Large, readable numbers with supporting text beneath
- Nested breakdown showing tweet vs non-tweet counts with bullet points
- Consistent dark theme with primary color accents

---

## 2026-01-23 - IMP-005
- Implemented API route to save imported bookmarks to Supabase
- Created domain extraction utility in `src/lib/extract-domain.ts`
- Created POST /api/bookmarks/import route with upsert logic
- Added comprehensive test coverage (domain extraction + API route)
- All 51 tests passing, build passes with no errors

**Files changed:**
- `src/lib/extract-domain.ts` (created)
- `src/lib/extract-domain.test.ts` (created)
- `src/app/api/bookmarks/import/route.ts` (created)
- `src/app/api/bookmarks/import/route.test.ts` (created)

**Learnings:**
- Vitest mocking requires defining mocks INSIDE vi.mock() factory, not as external variables
- Import route module AFTER setting up mocks using top-level await: `const { POST } = await import('./route')`
- JSON serialization converts Date objects to ISO strings, so API routes must handle both Date and string types
- Supabase upsert with `onConflict: 'url'` handles duplicate URLs gracefully (insert or update)
- URL constructor handles missing protocols by throwing error, so add `https://` prefix when missing
- Domain extraction: Use URL.hostname to get domain, remove 'www.' prefix for consistency
- Test mocks should return data matching expected counts (e.g., 2 bookmarks = return array of 2 items)

**API Route Design:**
- POST /api/bookmarks/import accepts array of ImportBookmark objects
- Transforms to database format with extracted domain, keeper flags, categorization status
- Uses upsert to handle duplicates (updates existing, inserts new)
- Returns success status and count of imported bookmarks
- Handles errors with appropriate status codes (400 for bad request, 500 for server errors)

---
## 2026-01-23 - CAT-001
- Implemented categorize page layout with TDD approach
- Created responsive layout with fixed header, progress bar, bookmark preview, and category picker
- Applied refined dark theme aesthetic with gradients, subtle animations, and glassmorphism
- Screenshot verified UI matches design intent: sleek dashboard aesthetic with smooth animations
- All 55 tests passing, build passes with no errors

**Files changed:**
- `src/app/categorize/page.tsx` (created)
- `src/app/categorize/page.test.tsx` (created)

**Learnings:**
- Supabase mock for tests needs chainable builder pattern: each method returns the builder object
- Create mock builder inside vi.mock() factory, define methods that return the same builder for chaining
- Pattern: `const builder: any = { select: () => builder, eq: () => builder, order: () => ({ data, error }) }`
- Server components can fetch data directly in the component without useEffect or client state
- Progress bar uses dynamic width calculation based on current index and total count
- Glassmorphism effect: `backdrop-blur-xl` + semi-transparent background + subtle borders

**Design decisions:**
- Dark theme with gradient background (zinc-950 via zinc-900)
- Emerald to teal gradient for progress bar and accent colors
- Fixed header with backdrop blur for professional dashboard feel
- Large centered preview area (min-height 500px) with placeholder icon and text
- Category picker grid (2-5 columns responsive) with hover effects and keyboard hints
- Keyboard shortcut display using `<kbd>` elements with styled backgrounds
- Decorative background glow on hover using absolute positioned gradient divs with blur

---

## 2026-01-23 - CAT-002
- Implemented CategoryPicker component with keyboard shortcuts
- Created comprehensive test suite with 8 test cases in category-picker.test.tsx
- Component displays top 10 main categories sorted by usage_count descending
- Keyboard shortcuts 1-9 and 0 select first 10 categories
- Click handlers work alongside keyboard shortcuts
- Selected category highlighted with emerald border and background
- "New category" button with [-] key hint displayed
- Integrated CategoryPicker into categorize page via CategorizeWrapper client component
- Server component fetches main categories (parent_id IS NULL) sorted by usage_count
- Screenshot verified UI matches design intent: sleek dashboard with real category data
- All 63 tests passing, build passes with no errors

**Files changed:**
- `src/components/categorize/category-picker.tsx` (created)
- `src/components/categorize/category-picker.test.tsx` (created)
- `src/components/categorize/categorize-wrapper.tsx` (created)
- `src/app/categorize/page.tsx` (updated - added categories fetch and CategoryPicker integration)
- `src/app/categorize/page.test.tsx` (updated - mock returns categories data)

**Learnings:**
- Keyboard event listeners in React: Use useEffect with window.addEventListener
- Clean up event listeners in useEffect return function to prevent memory leaks
- Server components can fetch data, pass to client components for interaction
- Client wrapper pattern: Server component fetches data, client component handles state and events
- Category sorting: sort by usage_count descending, slice(0, 10) for top 10
- Keyboard mapping: keys 1-9 map to index 0-8, key 0 maps to index 9
- Test keyboard events with userEvent.keyboard('1') from @testing-library/user-event
- Supabase query for main categories: .is('parent_id', null) to filter null values
- Mock Supabase differently per table: pass table name to factory, return different data

**Design decisions:**
- Top 10 categories accessible via keyboard (1-9, 0), rest shown in scrollable list (future)
- Selected category gets emerald-500 border and emerald-500/10 background tint
- Category name changes color to emerald-400 when selected for clear visual feedback
- Keyboard hints displayed at bottom for navigation (← → Delete)
- "New category" option always visible with [-] key hint

---


## 2026-01-23 - CAT-003
- Implemented subcategory picker UI with state machine transitions
- Created state machine with three states: main, subcategory, ready
- Added keyboard shortcuts for subcategory selection (1-9, 0)
- Implemented Enter key to return to main categories and add more pairs
- Display selected category pairs as chips with "MainCat > SubCat" format
- All 12 tests pass (5 new subcategory tests added)
- Build passes with no errors
- Screenshot verified UI transitions correctly between states

**Files changed:**
- `src/components/categorize/category-picker.tsx` (updated - added state machine)
- `src/components/categorize/category-picker.test.tsx` (updated - added 5 subcategory tests)
- `src/components/categorize/categorize-wrapper.tsx` (updated - removed selectedId prop)

**Learnings:**
- State machine pattern for multi-step UI flows: main -> subcategory -> ready
- Filter categories by parent_id to get subcategories: `.filter(c => c.parent_id === selectedMain.id)`
- Store selected category pairs as array of { main, sub } objects
- Use conditional rendering based on state to show different views
- Chips displayed using emerald color scheme with "&gt;" HTML entity for ">"
- Tests should cover all state transitions and keyboard interactions
- Remove obsolete tests when refactoring (selectedId test no longer applies)

**State machine implementation:**
- MAIN: Show main categories, 1-9/0 keys select main category, transition to SUBCATEGORY
- SUBCATEGORY: Show subcategories of selected main, 1-9/0 keys select subcategory, transition to READY
- READY: Show main categories again, Enter key resets to MAIN to add more pairs
- Selected pairs accumulate in array and display as chips above the picker

---


## 2026-01-23 - CAT-004
- Implemented bookmark preview for tweets using react-tweet
- Created getTweetId() utility function in src/lib/tweet-utils.ts to extract tweet IDs from twitter.com and x.com URLs
- Created TweetPreview component in src/components/categorize/tweet-preview.tsx
- Component uses react-tweet's Tweet component for tweet embeds
- Shows TweetNotFound fallback for invalid URLs with link to open in browser
- Integrated TweetPreview into categorize page with conditional rendering based on is_tweet flag
- All 79 tests passing, build passes with no errors
- Screenshot verified UI integration

**Files changed:**
- src/lib/tweet-utils.ts (created)
- src/lib/tweet-utils.test.ts (created)
- src/components/categorize/tweet-preview.tsx (created)
- src/components/categorize/tweet-preview.test.tsx (created)
- src/app/categorize/page.tsx (updated - integrated TweetPreview)
- src/app/categorize/page.test.tsx (updated - mocked TweetPreview)

**Learnings:**
- react-tweet is already installed and provides Tweet, TweetNotFound, TweetSkeleton components
- Tweet component accepts id prop (string of numeric tweet ID)
- getTweetId() extracts ID using regex matching twitter.com or x.com URLs with /status/ path
- react-tweet handles loading states and error states automatically
- No API key required for react-tweet (uses built-in endpoint)
- Component is client-side ('use client') for interactivity
- Fallback UI shows TweetNotFound component plus custom message and link to open in browser
- Server component (page.tsx) fetches bookmark data, passes to client component for rendering

**Design decisions:**
- TweetPreview wraps Tweet component in centered container with min-height matching design spec (500px)
- Fallback card matches design aesthetic: dark theme, emerald accent colors, rounded borders
- Shows "Open in browser" link for invalid tweet URLs
- Page conditionally renders TweetPreview for tweets, placeholder for non-tweets, empty state for no bookmarks

---

## 2026-01-23 - CAT-005
- Implemented bookmark preview for non-tweets using LinkCard component
- Created LinkCard component in src/components/categorize/link-card.tsx
- Component displays title, domain (extracted from URL), and full URL as clickable link
- Uses extractDomain() utility to normalize URLs and remove www. prefix
- Styled to match TweetPreview height/width with min-h-[500px]
- Dark theme with emerald accent colors consistent with app aesthetic
- All 88 tests passing, build passes with no errors

**Files changed:**
- src/components/categorize/link-card.tsx (created)
- src/components/categorize/link-card.test.tsx (created)
- src/app/categorize/page.tsx (updated - integrated LinkCard)
- src/app/categorize/page.test.tsx (updated - added LinkCard mock and test)

**Learnings:**
- TDD workflow effective: write failing tests first, implement until passing
- LinkCard uses lucide-react ExternalLink icon for consistency with design system
- Component styled to roughly match tweet embed dimensions (min-h-[500px])
- Conditional rendering in page: TweetPreview for tweets, LinkCard for non-tweets, empty state for no bookmarks
- Domain extraction utility from extract-domain.ts reused for consistency
- Added note that OG image previews will come in OG-002 task
- Tests verify title display, domain extraction, URL link properties, icon presence, and layout
- Mock LinkCard in page tests to isolate component behavior

**Design decisions:**
- Centered layout with max-w-2xl for readability
- ExternalLink icon in circular background for visual consistency
- Large title (text-2xl) with break-words to handle long titles
- Domain displayed in monospace font (font-mono) for technical feel
- URL truncated with max-w-xl to prevent overflow
- Light note about future OG image support at bottom
- Dark theme with zinc color palette and emerald accent links

---

## 2026-01-23 - CAT-006
- Implemented arrow key navigation between bookmarks in categorize flow
- Restructured CategorizeWrapper to manage bookmark navigation state
- Right arrow (→) moves to next bookmark when category is selected
- Left arrow (←) moves to previous bookmark
- Added shake animation when trying to navigate without category selected
- CategoryPicker now supports controlled selectedPairs prop for external state management
- Added completion state when all bookmarks are categorized
- All 98 tests passing, build passes with no errors

**Files changed:**
- src/components/categorize/categorize-wrapper.tsx (major refactor - added navigation state)
- src/components/categorize/categorize-wrapper.test.tsx (created - 10 navigation tests)
- src/components/categorize/category-picker.tsx (updated - controlled props support)
- src/app/categorize/page.tsx (updated - passes bookmarks to wrapper)
- src/app/categorize/page.test.tsx (updated - mocks CategorizeWrapper)
- src/app/globals.css (added shake animation keyframes)

**Learnings:**
- Controlled component pattern: Parent manages state, child receives via props and calls onChange
- useCallback for handlers passed to useEffect dependencies prevents infinite loops
- State machine reset: When controlled pairs cleared, reset internal picker state too
- Shake animation: CSS keyframes with 0.4s duration, alternating translateX offsets
- Server components fetch data, client components handle navigation state
- Test keyboard events with userEvent.keyboard('{ArrowRight}') for special keys

**Architecture decisions:**
- CategorizeWrapper now owns: currentIndex, selectedPairs, isShaking, isComplete states
- CategoryPicker supports both controlled (parent manages pairs) and uncontrolled modes
- Bookmarks array passed from server component to client wrapper for navigation
- Preloading optimization deferred to future iteration (performance enhancement)

---

## 2026-01-23 - CAT-007
- Implemented skip bookmark functionality with Delete/Backspace keys
- Added red flash animation when skipping (200ms pulse effect)
- Created POST /api/bookmarks/skip route to mark bookmarks as skipped in Supabase
- Skip functionality moves to next bookmark after skipping
- Shows completion state when skipping last bookmark
- All 107 tests passing, build passes with no errors

**Files changed:**
- src/components/categorize/categorize-wrapper.tsx (updated with skip handling)
- src/components/categorize/categorize-wrapper.test.tsx (added 6 skip tests)
- src/app/api/bookmarks/skip/route.ts (created)
- src/app/api/bookmarks/skip/route.test.ts (created)

**Learnings:**
- Async callbacks in useCallback work fine but test environment may not support relative fetch URLs
- Flash animation uses isSkipFlashing state with 200ms setTimeout to reset
- Red flash combines overlay div with conditional border and background classes on the card
- API route uses simple update query: `.update({ is_skipped: true }).eq('id', bookmarkId)`
- Test keyboard events: use `{Delete}` and `{Backspace}` with userEvent.keyboard

**Design decisions:**
- Skip flash uses red-500/20 overlay with animate-pulse plus red border highlight on card
- API call is fire-and-forget with try/catch to prevent blocking UI
- onSkip callback prop allows parent components to hook into skip events if needed
- Skip clears selected categories before moving to next bookmark

---

## 2026-01-23 - CAT-008
- Implemented save categorization to Supabase when navigating to next bookmark
- Created POST /api/bookmarks/categorize route
- Saves bookmark_categories junction records for all selected category pairs
- Sets is_categorized=true and clears is_skipped=false on bookmark
- Increments usage_count on selected categories via RPC function
- Created migration for increment_usage_counts SQL function
- Integrated API call into categorize-wrapper moveToNext handler
- All 118 tests passing, build passes with no errors

**Files changed:**
- src/app/api/bookmarks/categorize/route.ts (created)
- src/app/api/bookmarks/categorize/route.test.ts (created)
- src/components/categorize/categorize-wrapper.tsx (updated with API call)
- src/components/categorize/categorize-wrapper.test.tsx (added 2 API tests)
- supabase/migrations/003_increment_usage_counts_fn.sql (created)

**Learnings:**
- Supabase RPC functions are cleaner than multiple UPDATE statements for incrementing counts
- Create RPC function with `CREATE OR REPLACE FUNCTION` and `$$ LANGUAGE plpgsql`
- Junction table records save both main and sub category IDs (one entry per category)
- flatMap useful for extracting all IDs from category pairs: `pairs.flatMap(p => [p.main.id, p.sub.id])`
- Clearing is_skipped when categorizing allows un-skipping by going back and categorizing

**API Design:**
- POST /api/bookmarks/categorize accepts bookmarkId and categoryIds array
- Saves to bookmark_categories table (junction records)
- Updates bookmarks table (is_categorized=true, is_skipped=false)
- Calls RPC to increment usage_count on categories
- RPC failure logged but doesn't fail request since categorization succeeded

---

## 2026-01-23 - CAT-009
- Implemented notes field for bookmarks in categorize flow
- Created POST /api/bookmarks/notes route to save notes to Supabase
- Created NotesField component with auto-save on blur and Escape to close
- Integrated NotesField into CategorizeWrapper with N key toggle
- Notes field shows when N is pressed, hides on Escape or when navigating between bookmarks
- Auto-saves notes on blur if content changed (debounced via change detection)
- All 140 tests passing, build passes with no errors

**Files changed:**
- src/app/api/bookmarks/notes/route.ts (created)
- src/app/api/bookmarks/notes/route.test.ts (created)
- src/components/categorize/notes-field.tsx (created)
- src/components/categorize/notes-field.test.tsx (created)
- src/components/categorize/categorize-wrapper.tsx (updated with notes integration)
- src/components/categorize/categorize-wrapper.test.tsx (updated with notes tests)

**Learnings:**
- NotesField uses controlled state with initial value sync when bookmark changes
- Auto-save pattern: track lastSavedNotes separately from current notes to detect changes
- useRef for textarea focus on visibility change
- Keyboard events in textarea are handled locally (Escape), while N key is handled in parent
- Mock pattern for components that control visibility: render null when not visible

**Design decisions:**
- Notes field appears below the bookmark preview card
- Keyboard hint "Press N to add notes" always visible
- Escape closes notes field and saves changes
- Notes auto-save on blur (no manual save button needed)
- Notes visibility resets when navigating between bookmarks

---

## 2026-01-23 - CAT-010
- Implemented new category modal functionality
- Created POST /api/categories route to create categories in Supabase
- Created NewCategoryModal component with form, validation, and dark theme styling
- Integrated modal into CategoryPicker with minus key handler
- In main view: creates main category (parent_id: null)
- In subcategory view: creates subcategory (parent_id: selectedMain.id)
- New category immediately selectable after creation
- All 160 tests passing, build passes with no errors

**Files changed:**
- src/app/api/categories/route.ts (created)
- src/app/api/categories/route.test.ts (created)
- src/components/categorize/new-category-modal.tsx (created)
- src/components/categorize/new-category-modal.test.tsx (created)
- src/components/categorize/category-picker.tsx (updated with modal integration)
- src/components/categorize/category-picker.test.tsx (updated with modal tests)
- src/components/ui/input.tsx (added via shadcn)

**Learnings:**
- Vitest mocking for Supabase chainable methods: define mock functions at module level, mock the chain in beforeEach
- Pattern: mockInsert.mockReturnValue({ select: mockSelect }), mockSelect.mockReturnValue({ single: mockSingle })
- Dialog component from shadcn provides accessible modal with backdrop and animations
- Context-aware modals: pass parentCategory prop to determine if creating main category or subcategory
- Keyboard handlers should check if modal is open before processing shortcuts
- Input ref with setTimeout focus for modal animation timing

**Design decisions:**
- Modal uses dark theme (bg-zinc-900, border-zinc-800) consistent with app
- Emerald accent color for create button
- Form validation disables create button when name is empty
- Error state displayed below input field
- Cancel button uses ghost variant for minimal visual weight
- Modal clears state when opened (fresh start each time)

---

## 2026-01-23 - CAT-011
- Implemented progress persistence for categorize flow
- Created GET/POST /api/settings/position routes to load/save position from settings table
- Server component (page.tsx) loads saved position on initial render
- CategorizeWrapper saves position after each navigation (forward, backward, skip)
- Position resets to 0 when all bookmarks are completed
- Saved position is clamped to valid range if bookmarks were removed
- All 174 tests passing, build passes with no errors

**Files changed:**
- src/app/api/settings/position/route.ts (created)
- src/app/api/settings/position/route.test.ts (created)
- src/app/categorize/page.tsx (updated with position loading)
- src/app/categorize/page.test.tsx (updated with position tests)
- src/components/categorize/categorize-wrapper.tsx (updated with position saving)
- src/components/categorize/categorize-wrapper.test.tsx (updated with position tests)

**Learnings:**
- Settings table uses key/value (JSONB) pattern for flexible storage
- Supabase upsert with onConflict handles both insert and update cases
- Error code PGRST116 from Supabase means "row not found" and should return default value
- Server component can fetch saved position and pass as initialIndex to client component
- Position should be clamped to valid range in case bookmarks were deleted between sessions

**Design decisions:**
- Position saved after each navigation, not just on completion
- Position resets to 0 when completion screen shows (ready for next import)
- Settings key: categorize_position, value: { index: N }
- Position saving is fire-and-forget (non-blocking) to keep UI responsive
- Position clamped to max valid index if saved position exceeds bookmark count

---

## 2026-01-23 - E2E-001
- Implemented E2E test for import flow using Playwright
- Created sample bookmarks HTML fixture in e2e/fixtures/sample-bookmarks.html
- Test covers 4 scenarios: dropzone display, import summary modal, navigation to categorize, boundary not found alert
- Fixture contains 10 bookmarks with boundary at byebyepaywall.com in Tools folder
- 5 keepers (before boundary), 5 to categorize (3 tweets, 2 links)
- All 4 E2E tests pass, all 174 unit tests pass, build succeeds

**Files changed:**
- e2e/import.spec.ts (created)
- e2e/fixtures/sample-bookmarks.html (created)

**Learnings:**
- Playwright testDir configured as './e2e' in playwright.config.ts
- webServer config auto-starts dev server before tests
- For file input tests, use fileInput.setInputFiles(fixturePath) with path.join(__dirname, ...)
- When testing dynamic file content, use page.evaluate() with DataTransfer API to simulate file drop
- Avoid strict mode violations by using .first() or more specific locators when text appears multiple times
- E2E test fixtures should include boundary markers (Tools/byebyepaywall.com) to test full import flow

---

## 2026-01-23 - E2E-002
- Implemented E2E test for categorization flow using Playwright
- Created test file e2e/categorize.spec.ts with 5 test cases
- Seeds database with test bookmark and uses existing seeded categories
- Tests keyboard shortcuts for category selection (1 key), subcategory selection (1 key), and navigation (ArrowRight)
- Verifies bookmark is marked as categorized in database with correct category junction records
- Tests skip functionality with Delete key
- Tests completion screen display after categorizing last bookmark
- Tests that navigation is blocked (bookmark visible) when no category selected
- All 9 E2E tests pass, all 174 unit tests pass, build succeeds

**Files changed:**
- e2e/categorize.spec.ts (created)
- playwright.config.ts (updated to load dotenv)
- package.json (added dotenv as devDependency)

**Learnings:**
- Playwright tests running in parallel can conflict on database operations. Use `test.describe.configure({ mode: 'serial' })` for tests that modify shared database state
- Generate unique URLs per test using test title and timestamp to avoid unique constraint violations
- Use dotenv in playwright.config.ts to load environment variables for Supabase client
- Clean up test data in beforeEach (not just afterEach) to handle failed previous runs
- Test database operations: insert test data, run UI interactions, query database to verify changes
- beforeEach hook receives testInfo as second argument to access test metadata like title

---
